{
  "version": 3,
  "sources": ["../src/scheduler.ts", "../src/signal.ts", "../src/reactive.ts"],
  "sourcesContent": ["/**\n * View \u6A21\u677F\u5F15\u64CE \u2014 \u8C03\u5EA6\u5668\uFF08\u5FAE\u4EFB\u52A1\u6279\u5904\u7406\uFF09\n *\n * \u4F9B signal\u3001store\u3001effect \u5171\u7528\uFF1A\u8BA2\u9605\u8005/effect \u4E0D\u5728\u6B64 tick \u5185\u540C\u6B65\u6267\u884C\uFF0C\u800C\u662F\u52A0\u5165\u961F\u5217\uFF0C\n * \u7531\u4E00\u6B21\u5FAE\u4EFB\u52A1\u7EDF\u4E00 flush\uFF0C\u907F\u514D\u300C\u5199 \u2192 \u7ACB\u5373\u8DD1 effect \u2192 \u518D\u5199\u300D\u7684\u540C\u6B65\u91CD\u5165\u5BFC\u81F4\u4E3B\u7EBF\u7A0B\u5361\u6B7B\u3002\n */\n\n/** \u5F85\u6267\u884C\u7684\u4EFB\u52A1\u961F\u5217\uFF0C\u540C\u4E00 tick \u5185\u591A\u6B21\u5199\u5165\u53EA\u89E6\u53D1\u4E00\u6B21\u5FAE\u4EFB\u52A1 flush */\nconst queue = new Set<() => void>();\n/** \u590D\u7528\u6570\u7EC4\uFF0Cflush \u65F6\u5012\u5165\u540E\u904D\u5386\u6267\u884C\uFF0C\u907F\u514D\u6BCF\u6B21 new Set \u5206\u914D */\nconst queueCopy: (() => void)[] = [];\nlet scheduled = false;\n\n/**\n * \u6E05\u7A7A\u5F53\u524D\u961F\u5217\u5E76\u4F9D\u6B21\u6267\u884C\u6240\u6709\u4EFB\u52A1\uFF08\u5728\u5FAE\u4EFB\u52A1\u4E2D\u8C03\u7528\uFF09\n */\nfunction flushQueue(): void {\n  scheduled = false;\n  queueCopy.length = 0;\n  for (const run of queue) queueCopy.push(run);\n  queue.clear();\n  for (const run of queueCopy) run();\n}\n\n/**\n * \u5C06\u4EFB\u52A1\u52A0\u5165\u961F\u5217\uFF0C\u5E76\u786E\u4FDD\u5728\u672C tick \u7684\u5FAE\u4EFB\u52A1\u4E2D\u6267\u884C flush\n * \u4F9B signal setter\u3001store set\u3001createEffect \u7684\u300C\u4E0B\u6B21\u6267\u884C\u300D\u4F7F\u7528\uFF0C\u907F\u514D\u540C\u6B65\u91CD\u5165\n */\nexport function schedule(run: () => void): void {\n  queue.add(run);\n  if (!scheduled) {\n    scheduled = true;\n    if (typeof globalThis.queueMicrotask !== \"undefined\") {\n      globalThis.queueMicrotask(flushQueue);\n    } else if (typeof Promise !== \"undefined\") {\n      Promise.resolve().then(flushQueue);\n    } else {\n      setTimeout(flushQueue, 0);\n    }\n  }\n}\n\n/**\n * \u4ECE\u961F\u5217\u4E2D\u79FB\u9664\u4EFB\u52A1\uFF08\u5982 effect dispose \u65F6\u53D6\u6D88\u5C1A\u672A\u6267\u884C\u7684 run\uFF09\n */\nexport function unschedule(run: () => void): void {\n  queue.delete(run);\n}\n", "/**\n * View \u6A21\u677F\u5F15\u64CE \u2014 Signal\uFF08\u4FE1\u53F7\uFF09\n *\n * \u7EC6\u7C92\u5EA6\u54CD\u5E94\u5F0F\u5355\u5143\uFF1Agetter \u8BFB\u503C\u5E76\u767B\u8BB0\u5F53\u524D effect \u4E3A\u4F9D\u8D56\uFF0Csetter \u6539\u503C\u5E76\u901A\u77E5\u6240\u6709\u4F9D\u8D56\u7684 effect \u6267\u884C\u3002\n * \u901A\u77E5\u901A\u8FC7\u8C03\u5EA6\u5668\u5F02\u6B65\u6267\u884C\uFF0C\u907F\u514D effect \u5185\u300C\u8BFB\u2192\u5199\u300D\u5BFC\u81F4\u540C\u6B65\u91CD\u5165\u5361\u6B7B\u4E3B\u7EBF\u7A0B\u3002\n */\n\nimport { schedule } from \"./scheduler.ts\";\n\n/** \u5F53\u524D\u6B63\u5728\u6267\u884C\u7684 effect\uFF08run \u51FD\u6570\uFF09\uFF0C\u7528\u4E8E\u4F9D\u8D56\u6536\u96C6\uFF1Brun \u4E0A\u53EF\u6302 _subscriptionSets \u4F9B\u6E05\u7406 */\ntype EffectRun = (() => void) & { _subscriptionSets?: Subscriber[] };\nlet currentEffect: EffectRun | null = null;\n\n/**\n * \u5728 effect \u6267\u884C\u671F\u95F4\u8C03\u7528\uFF0C\u7528\u4E8E\u5C06\u5F53\u524D effect \u8BBE\u4E3A\u300C\u6B63\u5728\u6267\u884C\u300D\u4EE5\u4FBF signal \u7684 getter \u80FD\u767B\u8BB0\u4F9D\u8D56\n * @internal \u7531 effect.ts \u7684 createEffect \u4F7F\u7528\n */\nexport function setCurrentEffect(effect: (() => void) | null): void {\n  currentEffect = effect as EffectRun | null;\n}\n\n/**\n * \u83B7\u53D6\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684 effect\n * @internal\n */\nexport function getCurrentEffect(): (() => void) | null {\n  return currentEffect;\n}\n\n/** \u5355\u4E2A signal \u7684\u8BA2\u9605\u8005\uFF08effect \u7684\u91CD\u65B0\u6267\u884C\u51FD\u6570\uFF09\u5217\u8868 */\ntype Subscriber = Set<() => void>;\n\n/**\n * \u521B\u5EFA\u54CD\u5E94\u5F0F\u4FE1\u53F7\n *\n * @param initialValue \u521D\u59CB\u503C\n * @returns [getter, setter] \u5143\u7EC4\uFF1Agetter \u8BFB\u503C\u5E76\u767B\u8BB0\u4F9D\u8D56\uFF0Csetter \u5199\u503C\u5E76\u901A\u77E5\u4F9D\u8D56\n *\n * @example\n * const [count, setCount] = createSignal(0);\n * createEffect(() => console.log(count())); // \u6BCF\u6B21 setCount \u540E\u90FD\u4F1A\u6253\u5370\n * setCount(1);\n */\nexport function createSignal<T>(\n  initialValue: T,\n): [() => T, (value: T | ((prev: T) => T)) => void] {\n  let value = initialValue;\n  const subscribers: Subscriber = new Set();\n\n  const getter = (): T => {\n    if (currentEffect) {\n      subscribers.add(currentEffect);\n      if (currentEffect._subscriptionSets) {\n        currentEffect._subscriptionSets.push(subscribers);\n      }\n    }\n    return value;\n  };\n\n  const setter = (next: T | ((prev: T) => T)): void => {\n    const nextValue = typeof next === \"function\"\n      ? (next as (prev: T) => T)(value)\n      : next;\n    if (Object.is(value, nextValue)) {\n      return;\n    }\n    value = nextValue;\n    subscribers.forEach((run) => schedule(run));\n  };\n\n  return [markSignalGetter(getter), setter];\n}\n\n/**\n * \u5224\u65AD\u4E00\u4E2A\u51FD\u6570\u662F\u5426\u4E3A view \u7684 signal getter\uFF08\u7528\u4E8E dom \u5C42\u533A\u5206\u300C\u9700\u54CD\u5E94\u5F0F\u7ED1\u5B9A\u7684 prop\u300D\u4E0E\u666E\u901A\u51FD\u6570\u5982\u4E8B\u4EF6\u5904\u7406\uFF09\n * \u901A\u8FC7 getter \u4E0A\u6302\u8F7D\u7684\u6807\u8BB0\u5224\u65AD\u3002\n */\nexport const SIGNAL_GETTER_MARKER = Symbol.for(\"view.signalGetter\");\n\n/** \u7ED9 getter \u6253\u6807\u8BB0\uFF0C\u4F9B isSignalGetter \u4F7F\u7528 */\nexport function markSignalGetter<T>(getter: () => T): () => T {\n  (getter as unknown as { [SIGNAL_GETTER_MARKER]: true })[\n    SIGNAL_GETTER_MARKER\n  ] = true;\n  return getter;\n}\n\nexport function isSignalGetter(fn: unknown): fn is () => unknown {\n  return typeof fn === \"function\" &&\n    (fn as unknown as { [SIGNAL_GETTER_MARKER]?: boolean })[\n        SIGNAL_GETTER_MARKER\n      ] === true;\n}\n", "/**\n * @dreamer/view/reactive \u2014 \u54CD\u5E94\u5F0F\u5BF9\u8C61\uFF08\u7528\u4E8E\u8868\u5355 model \u7B49\u53CC\u5411\u7ED1\u5B9A\uFF09\n *\n * \u804C\u8D23\u5355\u4E00\uFF1A\u63D0\u4F9B createReactive(initial)\uFF0C\u8FD4\u56DE\u53EF\u8BFB\u5199\u3001\u4E0E createEffect \u8054\u52A8\u7684\u4EE3\u7406\u5BF9\u8C61\u3002\n * \u4E0D\u653E\u5728 store\uFF1Astore \u8D1F\u8D23\u5B8C\u6574\u72B6\u6001\uFF08getters/actions/persist\uFF09\uFF1B\u4E0D\u653E\u5728 signal\uFF1Asignal \u662F [get, set] \u5143\u7EC4\u3002\n *\n * \u7528\u6CD5\uFF1Aconst model = createReactive({ name: \"\", age: \"\" }); <Form model={model} />\uFF1B\u8868\u5355\u5185 model.name = value \u5373\u53EF\u53CC\u5411\u66F4\u65B0\u3002\n */\n\nimport { getCurrentEffect } from \"./signal.ts\";\nimport { schedule } from \"./scheduler.ts\";\n\ntype SubscriberSet = Set<() => void>;\n\n/**\n * \u4E3A\u5D4C\u5957\u5BF9\u8C61\u521B\u5EFA\u4EE3\u7406\uFF1Aget \u767B\u8BB0\u5F53\u524D effect\uFF0Cset \u901A\u77E5\u8BA2\u9605\u8005\n */\nfunction createNestedProxy<T extends object>(\n  target: T,\n  subscribers: SubscriberSet,\n  proxyCache: WeakMap<object, object>,\n): T {\n  const cached = proxyCache.get(target);\n  if (cached) return cached as T;\n  const proxy = new Proxy(target, {\n    get(t, key: string) {\n      const effect = getCurrentEffect();\n      if (effect) subscribers.add(effect);\n      const value = Reflect.get(t, key);\n      if (value !== null && typeof value === \"object\") {\n        return createNestedProxy(\n          value as object,\n          subscribers,\n          proxyCache,\n        ) as T[keyof T];\n      }\n      return value;\n    },\n    set(t, key: string, value: unknown) {\n      const ok = Reflect.set(t, key, value);\n      if (ok) subscribers.forEach((run) => schedule(run));\n      return ok;\n    },\n  }) as T;\n  proxyCache.set(target, proxy);\n  return proxy;\n}\n\n/**\n * \u521B\u5EFA\u54CD\u5E94\u5F0F\u5BF9\u8C61\uFF08Proxy\uFF09\uFF0C\u8BFB\u5199\u4E0E createEffect \u8054\u52A8\uFF0C\u9002\u5408\u4F5C\u4E3A\u8868\u5355 model \u7B49\u300C\u4F20\u4E00\u4E2A\u53D8\u91CF\u3001\u53CC\u5411\u66F4\u65B0\u300D\u7684\u573A\u666F\n *\n * @param initial \u521D\u59CB\u5BF9\u8C61\uFF08\u4F1A\u88AB\u6D45\u62F7\u8D1D\uFF0C\u4E0D\u4F1A\u76F4\u63A5\u4FEE\u6539\u5165\u53C2\uFF09\n * @returns \u54CD\u5E94\u5F0F\u4EE3\u7406\uFF0C\u5728 effect \u4E2D\u8BFB\u53D6\u4F1A\u767B\u8BB0\u4F9D\u8D56\uFF0C\u4EFB\u610F\u5C5E\u6027\u8D4B\u503C\u4F1A\u89E6\u53D1\u8BA2\u9605\u66F4\u65B0\n *\n * @example\n * const model = createReactive({ name: \"\", age: \"\", sex: \"\" });\n * <Form model={model} />\n * // \u8868\u5355\u5185\uFF1Aprops.model.name = e.target.value \u5373\u53EF\n */\nexport function createReactive<T extends Record<string, unknown>>(\n  initial: T,\n): T {\n  const state = { ...initial };\n  const subscribers: SubscriberSet = new Set();\n  const proxyCache = new WeakMap<object, object>();\n  return createNestedProxy(state, subscribers, proxyCache);\n}\n"],
  "mappings": "AAQA,IAAMA,EAAQ,IAAI,IAEZC,EAA4B,CAAC,EAC/BC,EAAY,GAKhB,SAASC,GAAmB,CAC1BD,EAAY,GACZD,EAAU,OAAS,EACnB,QAAWG,KAAOJ,EAAOC,EAAU,KAAKG,CAAG,EAC3CJ,EAAM,MAAM,EACZ,QAAWI,KAAOH,EAAWG,EAAI,CACnC,CAMO,SAASC,EAASD,EAAuB,CAC9CJ,EAAM,IAAII,CAAG,EACRF,IACHA,EAAY,GACR,OAAO,WAAW,eAAmB,IACvC,WAAW,eAAeC,CAAU,EAC3B,OAAO,QAAY,IAC5B,QAAQ,QAAQ,EAAE,KAAKA,CAAU,EAEjC,WAAWA,EAAY,CAAC,EAG9B,CC7BA,IAAIG,EAAkC,KAc/B,SAASC,GAAwC,CACtD,OAAOC,CACT,CAkDO,IAAMC,EAAuB,OAAO,IAAI,mBAAmB,EC5DlE,SAASC,EACPC,EACAC,EACAC,EACG,CACH,IAAMC,EAASD,EAAW,IAAIF,CAAM,EACpC,GAAIG,EAAQ,OAAOA,EACnB,IAAMC,EAAQ,IAAI,MAAMJ,EAAQ,CAC9B,IAAIK,EAAGC,EAAa,CAClB,IAAMC,EAASC,EAAiB,EAC5BD,GAAQN,EAAY,IAAIM,CAAM,EAClC,IAAME,EAAQ,QAAQ,IAAIJ,EAAGC,CAAG,EAChC,OAAIG,IAAU,MAAQ,OAAOA,GAAU,SAC9BV,EACLU,EACAR,EACAC,CACF,EAEKO,CACT,EACA,IAAIJ,EAAGC,EAAaG,EAAgB,CAClC,IAAMC,EAAK,QAAQ,IAAIL,EAAGC,EAAKG,CAAK,EACpC,OAAIC,GAAIT,EAAY,QAASU,GAAQC,EAASD,CAAG,CAAC,EAC3CD,CACT,CACF,CAAC,EACD,OAAAR,EAAW,IAAIF,EAAQI,CAAK,EACrBA,CACT,CAaO,SAASS,EACdC,EACG,CACH,IAAMC,EAAQ,CAAE,GAAGD,CAAQ,EAG3B,OAAOf,EAAkBgB,EAFU,IAAI,IACpB,IAAI,OACgC,CACzD",
  "names": ["queue", "queueCopy", "scheduled", "flushQueue", "run", "schedule", "currentEffect", "getCurrentEffect", "currentEffect", "SIGNAL_GETTER_MARKER", "createNestedProxy", "target", "subscribers", "proxyCache", "cached", "proxy", "t", "key", "effect", "getCurrentEffect", "value", "ok", "run", "schedule", "createReactive", "initial", "state"]
}
